# 任务域和关联对象功能 - 使用指南

## 🎉 功能概览

任务模块现在支持按业务线（任务域）和关联对象进行管理，让任务归属清晰、筛选精准、统计准确！

---

## ✨ 核心功能

### 1. 任务域分类

将所有任务归类到4个业务域：

| 任务域 | 图标 | 颜色 | 说明 | 适用场景 |
|--------|------|------|------|---------|
| 🔨 通用任务 | Briefcase | 灰色 | 不属于特定业务线的任务 | 日常工作、临时事项 |
| 👥 学生服务 | Users | 蓝色 | 学生相关的服务任务 | 申请指导、文书服务、选校咨询 |
| 🏢 公司运营 | Building2 | 紫色 | 内部运营管理任务 | 团队会议、培训、流程优化 |
| 📣 市场营销 | Megaphone | 粉色 | 市场推广相关任务 | 线索跟进、活动策划、品牌建设 |

### 2. 关联对象类型

每个任务可以关联具体对象：

| 类型 | 说明 | 可选对象 |
|------|------|---------|
| 👨‍🎓 关联学生 | 任务关联到特定学生 | 从学生列表选择 |
| 🎯 关联线索 | 任务关联到潜在客户 | 从线索列表选择 |
| 👤 关联员工 | 任务关联到团队成员 | 从员工列表选择 |
| ⭕ 无关联 | 任务不关联具体对象 | - |

---

## 🎯 如何使用

### 📝 创建任务时设置

1. 点击"新建任务"按钮
2. 填写基本信息（标题、描述等）
3. **选择任务域** - 从下拉框选择业务线
4. **选择关联类型** - 学生/线索/员工/无
5. **选择具体对象** - 如果选了关联类型，选择具体人员
6. 保存

### ✏️ 在侧边栏编辑

#### 编辑任务域
1. 打开任务详情侧边栏
2. 点击紫色的"任务域"卡片
3. 在下拉框选择新的任务域
4. 点击"保存"

#### 编辑关联对象类型
1. 点击蓝色的"关联对象"卡片
2. 选择关联类型（学生/线索/员工/无）
3. 点击"保存"

#### 编辑具体关联对象
1. 选择关联类型后，下方会出现对象选择器
2. 点击对象选择器
3. 从下拉列表选择具体对象
4. 点击"保存"

### 🔍 使用筛选功能

#### 按任务域筛选
1. 在筛选栏找到"全部任务域"下拉框
2. 选择要查看的业务线
3. 任务列表自动过滤
4. 查看筛选标签（青色）

#### 按关联类型筛选
1. 在筛选栏找到"全部关联类型"下拉框
2. 选择类型（学生/线索/员工/无关联）
3. 任务列表自动过滤
4. 查看筛选标签（蓝绿色）

#### 组合筛选
可以同时使用多个筛选条件：
- 任务域 + 状态
- 关联类型 + 优先级
- 学生 + 时间范围
- 任务域 + 关联类型 + 状态

### 📊 查看统计数据

#### 主统计面板
页面顶部显示6个关键指标：
- 全部任务
- 待处理
- 进行中
- 已完成
- 今天到期
- 已逾期

#### 任务域分布面板
统计面板下方显示各业务线任务分布：
- 每个任务域的任务数量
- 占总任务的百分比
- 彩色图标标识

---

## 📱 三种视图下的显示

### 列表视图（默认）

**任务域列**
- 专属的任务域列
- 彩色图标 + 文字标签
- 一眼识别任务归属

**关联对象列**
- 显示头像和名称
- 学生显示状态标签
- 线索显示"线索"标识

### 看板视图

**任务卡片顶部**
- 任务域徽章
- 图标和文字

**关联对象区块**
- 头像圆形标识
- 对象名称
- 线索特殊标识

### 日历视图

**彩色左边框**
- 蓝色边框 = 学生服务
- 紫色边框 = 公司运营
- 粉色边框 = 市场营销
- 灰色边框 = 通用任务

**悬浮提示**
- 显示完整任务域名称
- 显示关联对象名称

---

## ⚠️ 历史任务处理

### 历史任务提示横幅

系统会自动检测缺少信息的任务，并在页面顶部显示琥珀色提示横幅：

**显示内容**：
- X 个任务缺少任务域
- Y 个任务缺少关联对象
- 操作提示

**如何处理**：
1. 点击需要完善的任务
2. 在侧边栏编辑任务域
3. 选择关联对象类型和具体对象
4. 保存更新

**关闭横幅**：
- 点击右上角 X 图标关闭
- 系统会记住你的选择
- 下次打开不再显示

---

## 🎨 视觉识别指南

### 筛选标签颜色

| 筛选类型 | 颜色 | 示例 |
|---------|------|------|
| 任务域 | 青色 (Cyan) | "任务域: 学生服务" |
| 关联类型 | 蓝绿 (Teal) | "关联类型: 学生" |
| 学生 | 靛蓝 (Indigo) | "学生: 汪子涵" |
| 状态 | 蓝色 (Blue) | "状态: 进行中" |
| 优先级 | 紫色 (Purple) | "优先级: 高" |
| 标签 | 绿色 (Green) | "标签: 文书" |
| 时间 | 橙色 (Orange) | "时间: 本周" |

### 任务域颜色

| 任务域 | 卡片背景 | 边框颜色 | 使用场景 |
|--------|---------|---------|---------|
| 通用任务 | 灰色 | gray-100 | 列表/看板 |
| 学生服务 | 蓝色 | blue-100 | 列表/看板 |
| 公司运营 | 紫色 | purple-100 | 列表/看板 |
| 市场营销 | 粉色 | pink-100 | 列表/看板 |

---

## 💡 最佳实践

### 1. 创建任务时
✅ **推荐**：明确选择任务域和关联对象
- 便于后续筛选和统计
- 团队协作更清晰
- 数据分析更准确

❌ **不推荐**：全部选择"通用任务"或"无关联"
- 失去分类优势
- 无法精准筛选
- 统计数据不准确

### 2. 任务域选择建议

**学生服务**：
- 申请材料准备
- 选校咨询
- 文书辅导
- 面试培训
- 跟进服务

**公司运营**：
- 团队会议
- 内部培训
- 流程优化
- 系统维护
- 人员管理

**市场营销**：
- 线索跟进
- 活动策划
- 内容创作
- 品牌推广
- 渠道合作

**通用任务**：
- 临时事项
- 跨部门协作
- 不明确归属的工作

### 3. 关联对象选择建议

**关联学生**：
- 学生的所有服务任务
- 学生专属的跟进事项
- 与学生直接相关的工作

**关联线索**：
- 潜在客户的跟进
- 咨询预约跟进
- 转化推进任务

**关联员工**：
- 员工培训计划
- 绩效评估
- 一对一辅导

**无关联**：
- 团队协作任务
- 系统性工作
- 不针对具体对象的事项

---

## 📈 数据分析与报表

### 任务域分布
通过统计面板了解：
- 各业务线的任务负载
- 资源分配是否合理
- 团队工作重心

### 关联对象统计
通过筛选了解：
- 每个学生的任务数量
- 线索跟进的完成情况
- 员工的工作饱和度

### 优化建议
1. 定期查看任务域分布
2. 平衡各业务线资源
3. 重点关注学生服务任务
4. 及时跟进线索转化

---

## 🔧 高级技巧

### 1. 快速定位学生任务
```
筛选器设置：
- 任务域：学生服务
- 关联类型：学生
- 学生：选择具体学生
```

### 2. 查看运营工作
```
筛选器设置：
- 任务域：公司运营
- 状态：进行中
```

### 3. 跟进市场线索
```
筛选器设置：
- 任务域：市场营销
- 关联类型：线索
- 时间：本周
```

### 4. 清理遗留任务
```
1. 查看历史任务横幅
2. 点击进入任务详情
3. 补充任务域和关联对象
4. 逐步完善所有历史任务
```

---

## 🐛 常见问题

### Q1: 为什么看不到任务域筛选器？
**A**: 需要先执行数据库迁移SQL，添加必要字段。

### Q2: 历史任务没有任务域怎么办？
**A**: 
1. 查看页面顶部的琥珀色横幅
2. 点击任务进入侧边栏
3. 编辑任务域和关联对象
4. 保存即可

### Q3: 关联对象选择器不显示？
**A**: 
- 确保先选择了关联类型
- 如果选择"无关联"，选择器会隐藏
- 切换关联类型后选择器会出现

### Q4: 修改任务域会影响什么？
**A**:
- 筛选结果会更新
- 统计数据会重新计算
- 视图标识会改变
- 不影响任务其他信息

### Q5: 可以批量修改任务域吗？
**A**: 
目前暂不支持批量修改，建议：
1. 使用筛选功能定位相似任务
2. 逐个编辑并保存
3. 或联系管理员执行SQL批量更新

---

## 📊 数据库迁移

### 迁移前检查

运行检查脚本：
```bash
node database_migrations/run_migration.js
```

应该显示：
```
❌ 需要添加：task_domain
❌ 需要添加：linked_entity_type  
❌ 需要添加：linked_entity_id
```

### 执行迁移

**步骤1**: 访问 Supabase SQL Editor
```
https://supabase.com/dashboard/project/swyajeiqqewyckzbfkid/sql
```

**步骤2**: 复制以下SQL并执行

```sql
-- 添加字段
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS task_domain VARCHAR(50) DEFAULT 'general';
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS linked_entity_type VARCHAR(20) DEFAULT 'none';
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS linked_entity_id INTEGER;

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_tasks_domain ON tasks(task_domain);
CREATE INDEX IF NOT EXISTS idx_tasks_linked_entity ON tasks(linked_entity_type, linked_entity_id);

-- 回填历史数据
UPDATE tasks 
SET task_domain = 'student_success',
    linked_entity_type = 'student',
    linked_entity_id = related_student_id
WHERE related_student_id IS NOT NULL AND task_domain = 'general';

UPDATE tasks 
SET task_domain = 'marketing',
    linked_entity_type = 'lead',
    linked_entity_id = related_lead_id
WHERE related_lead_id IS NOT NULL AND task_domain = 'general';
```

**步骤3**: 验证迁移

再次运行检查脚本：
```bash
node database_migrations/run_migration.js
```

应该显示：
```
✅ task_domain 已存在
✅ linked_entity_type 已存在
✅ linked_entity_id 已存在

📊 数据分布统计...
```

### 迁移后操作

1. **清除浏览器缓存**
   - Chrome: Cmd+Shift+Delete (Mac) / Ctrl+Shift+Delete (Windows)
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **刷新页面**
   - 硬刷新: Cmd+Shift+R (Mac) / Ctrl+Shift+F5 (Windows)

3. **验证功能**
   - 查看统计面板是否显示任务域分布
   - 测试任务域筛选器
   - 编辑一个任务的域和关联对象

---

## 🎓 操作演示

### 场景1: 为学生创建服务任务

```
1. 点击"新建任务"
2. 标题: "准备推荐信材料"
3. 任务域: 选择"学生服务"
4. 关联类型: 选择"关联学生"
5. 选择学生: "汪子涵"
6. 设置截止日期和负责人
7. 保存
```

### 场景2: 跟进市场线索

```
1. 点击"新建任务"
2. 标题: "联系咨询客户张女士"
3. 任务域: 选择"市场营销"
4. 关联类型: 选择"关联线索"
5. 选择线索: "张女士"
6. 优先级: 高
7. 保存
```

### 场景3: 查看某学生的所有任务

```
1. 任务域筛选: 选择"学生服务"
2. 学生筛选: 选择"汪子涵"
3. 查看过滤后的任务列表
4. 了解该学生的所有服务进展
```

### 场景4: 统计本周市场任务

```
1. 任务域筛选: 选择"市场营销"
2. 时间筛选: 选择"本周"
3. 状态筛选: 选择"进行中"
4. 查看结果并安排资源
```

---

## 🚀 团队协作建议

### 角色分工

**学生顾问**：
- 主要使用"学生服务"域
- 关联具体学生
- 关注学生任务统计

**市场人员**：
- 主要使用"市场营销"域
- 关联线索对象
- 关注转化相关任务

**运营人员**：
- 使用"公司运营"域
- 管理内部流程任务
- 协调跨部门工作

**管理员**：
- 查看全局任务分布
- 平衡资源分配
- 监控各域进展

### 沟通规范

1. **创建任务时明确域和关联**
2. **周会review各域任务完成情况**
3. **月度分析业务线分布趋势**
4. **及时完善历史任务信息**

---

## 📝 待办提醒

### 迁移后第一周

- [ ] 执行数据库迁移SQL
- [ ] 验证迁移成功
- [ ] 清除浏览器缓存
- [ ] 测试所有新功能
- [ ] 完善5个历史任务作为示范

### 第二周

- [ ] 培训团队成员使用新功能
- [ ] 建立任务域使用规范
- [ ] 完善更多历史任务
- [ ] 收集用户反馈

### 持续优化

- [ ] 每周查看任务域分布
- [ ] 调整资源配置
- [ ] 优化任务归类规则
- [ ] 完善更多高级功能

---

## 🎯 快速参考卡

### 侧边栏可编辑字段

| 字段 | 编辑方式 | 位置 |
|------|---------|------|
| ✅ 任务标题 | 点击标题区域 | 顶部 |
| ✅ 任务域 | 点击紫色卡片 | 标题下方左侧 |
| ✅ 关联类型 | 点击蓝色卡片 | 标题下方右侧 |
| ✅ 关联对象 | 点击对象选择器 | 关联类型下方 |
| ✅ 开始日期 | 点击日期区域 | 任务信息区 |
| ✅ 截止日期 | 点击日期区域 | 任务信息区 |
| ✅ 状态 | 下拉选择 | 任务信息区 |
| ✅ 负责人 | 多选下拉 | 任务信息区 |
| ✅ 优先级 | 下拉选择 | 任务信息区 |
| ✅ 描述 | 点击描述区域 | 任务信息区 |

### 筛选器快速键

| 筛选项 | 位置 | 清除方式 |
|--------|------|---------|
| 任务域 | 第4个下拉框 | 点击青色标签X |
| 关联类型 | 第5个下拉框 | 点击蓝绿标签X |
| 学生 | 第6个下拉框 | 点击靛蓝标签X |
| 全部清除 | - | 点击"重置筛选" |

---

## ✅ 功能检查清单

### 基础功能
- [x] 任务域筛选正常
- [x] 关联类型筛选正常
- [x] 学生筛选正常
- [x] 筛选标签显示
- [x] 统计面板显示

### 编辑功能
- [x] 侧边栏可编辑任务域
- [x] 侧边栏可编辑关联类型
- [x] 侧边栏可选择关联对象
- [x] 编辑后实时更新
- [x] 数据正确保存

### 视图显示
- [x] 列表视图显示域标识
- [x] 看板视图显示域徽章
- [x] 日历视图彩色边框
- [x] 三视图一致性

### 历史数据
- [x] 横幅提示显示
- [x] 统计准确
- [x] 可关闭记忆
- [x] 引导完善

---

**更新日期**: 2025-11-02  
**版本**: v2.0  
**状态**: ✅ 全部功能已完成，等待数据库迁移

