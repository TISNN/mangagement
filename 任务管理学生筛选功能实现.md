# 任务管理 - 学生筛选功能实现

## 📋 功能概述

为任务管理页面增加了学生筛选功能，现在用户可以通过下拉框快速筛选特定学生相关的任务。

**重要改进**: 筛选下拉框只显示已经关联到任务的学生，避免显示大量未使用的学生数据，使筛选更加精准和实用。

## ✅ 完成的工作

### 1. 类型定义更新
**文件**: `src/pages/admin/TaskManagement/types/task.types.ts`

在 `TaskFilters` 接口中添加了 `student` 字段：
```typescript
export interface TaskFilters {
  search: string;
  status: string | null;
  priority: string | null;
  assignee: string | null;
  student: string | null; // 新增：学生筛选
  tag: string | null;
  timeView: 'all' | 'today' | 'tomorrow' | 'week' | 'expired';
}
```

### 2. 筛选逻辑更新
**文件**: `src/pages/admin/TaskManagement/hooks/useTaskFilters.ts`

- 在初始筛选状态中添加 `student: null`
- 在过滤逻辑中添加学生筛选判断：
  ```typescript
  // 5. 学生过滤
  if (filters.student) {
    if (!task.relatedStudent || task.relatedStudent.id !== filters.student) {
      return false;
    }
  }
  ```
- 在重置函数中包含学生筛选的重置
- **新增**: 添加 `relatedStudents` 计算属性，从所有任务中提取已关联的唯一学生列表：
  ```typescript
  const relatedStudents = useMemo(() => {
    const studentMap = new Map<string, { id: string; name: string; avatar: string | null; status?: string; is_active?: boolean }>();
    
    tasks.forEach(task => {
      if (task.relatedStudent) {
        if (!studentMap.has(task.relatedStudent.id)) {
          studentMap.set(task.relatedStudent.id, task.relatedStudent);
        }
      }
    });
    
    return Array.from(studentMap.values()).sort((a, b) => a.name.localeCompare(b.name));
  }, [tasks]);
  ```

### 3. UI组件更新
**文件**: `src/pages/admin/TaskManagement/components/TaskFilters/index.tsx`

- 更新 `students` prop 类型为已关联学生的类型：`Array<{ id: string; name: string; avatar: string | null; ... }>`
- 添加学生筛选下拉框（仅显示已关联的学生）：
  ```tsx
  {/* 学生筛选（仅显示已关联的学生） */}
  {students.length > 0 && (
    <select
      value={filters.student || ''}
      onChange={(e) => onFilterChange('student', e.target.value || null)}
      className="..."
    >
      <option value="">全部学生 ({students.length})</option>
      {students.map(student => (
        <option key={student.id} value={student.id}>
          {student.name} {!student.is_active && '(非活跃)'}
        </option>
      ))}
    </select>
  )}
  ```
- 在下拉框显示已关联学生的数量，方便用户了解
- 添加学生筛选标签显示：
  ```tsx
  {filters.student && (
    <span className="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-full text-xs">
      学生: {students.find(s => s.id.toString() === filters.student)?.name || filters.student}
      <button onClick={() => onFilterChange('student', null)}>
        <X className="w-3 h-3" />
      </button>
    </span>
  )}
  ```

### 4. 主页面更新
**文件**: `src/pages/admin/TaskManagement/index.tsx`

- 从 `useTaskFilters` hook 中解构 `relatedStudents`
- 将 `relatedStudents` 传递给 `TaskFilters` 组件：
```tsx
const { filters, updateFilter, resetFilters, filteredTasks, allTags, relatedStudents } = useTaskFilters(tasks);

...

<TaskFilters
  filters={filters}
  onFilterChange={updateFilter}
  onReset={resetFilters}
  allTags={allTags}
  students={relatedStudents} // 传递已关联的学生
/>
```

## 🎯 功能特点

1. **智能显示**: 只有在有学生数据时才显示学生筛选下拉框
2. **精准筛选**: ⭐ 只显示已关联到任务的学生，不显示所有学生数据
3. **数量统计**: 下拉框显示已关联学生的总数量（如"全部学生 (5)"）
4. **状态标记**: 非活跃的学生会在名称后显示"(非活跃)"标记
5. **标签显示**: 选中学生后会在下方显示靛蓝色的筛选标签
6. **快速清除**: 可以通过点击标签上的 X 按钮快速清除学生筛选
7. **联动搜索**: 学生筛选与搜索框互不冲突，可以同时使用
8. **重置功能**: 点击"重置筛选"按钮会同时清除学生筛选
9. **自动去重**: 使用 Map 确保每个学生只出现一次
10. **智能排序**: 学生按名称字母顺序排列

## 📱 使用方法

1. 进入任务管理页面
2. 在筛选栏中找到"全部学生"下拉框
3. 选择要筛选的学生
4. 任务列表会自动更新，只显示该学生相关的任务
5. 可以点击下方的学生标签或使用"重置筛选"按钮清除筛选

## 🔍 筛选逻辑

- **学生列表生成**: 从所有任务中提取已关联的学生，自动去重和排序
- **任务过滤**: 只有关联了指定学生的任务才会被显示
- **组合筛选**: 可以与其他筛选条件（状态、优先级、时间等）组合使用
- **搜索互补**: 搜索框中输入学生名字也能找到相关任务
- **性能优化**: 使用 useMemo 缓存学生列表，避免重复计算

## ✨ 视觉设计

- 学生筛选下拉框与其他筛选器保持一致的样式
- 使用靛蓝色（indigo）作为学生筛选标签的主题色
- 支持深色模式，自动适配主题颜色
- 悬停效果和过渡动画保持流畅

## 🔧 技术实现

- 使用 TypeScript 确保类型安全
- 采用 React Hooks 实现状态管理
- 使用 useMemo 优化筛选性能
- 所有代码都有详细的注释说明

## 📝 注意事项

- **动态列表**: 学生列表根据当前任务动态生成，不从数据库单独加载
- **实时更新**: 当任务关联的学生变化时，筛选列表自动更新
- **筛选依据**: 筛选逻辑基于任务的 `relatedStudent` 对象
- **状态保留**: 非活跃学生仍然会在列表中显示，但有特殊标记
- **空状态处理**: 如果没有任何任务关联学生，下拉框不会显示

## 🆕 版本更新

### v1.1 - 2025-11-02
- ✅ **重要改进**: 筛选列表只显示已关联到任务的学生
- ✅ 添加学生数量统计显示
- ✅ 使用 Map 数据结构优化去重逻辑
- ✅ 添加按名称排序功能

### v1.0 - 2025-11-02
- ✅ 初始版本：添加学生筛选基础功能

---

**最后更新**: 2025-11-02
**状态**: ✅ 已完成并测试通过
**代码检查**: 无 linter 错误

