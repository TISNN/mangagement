# ä»»åŠ¡ç®¡ç†åŠŸèƒ½ - Supabase å®ç°è¯´æ˜

## âœ… å·²åˆ›å»ºçš„å†…å®¹

### 1. **Supabase æ•°æ®åº“è¡¨ç»“æ„**

#### `tasks` è¡¨ (ä»»åŠ¡ä¸»è¡¨)
```sql
tasks {
  id: integer (ä¸»é”®)
  title: varchar (ä»»åŠ¡æ ‡é¢˜) *å¿…å¡«
  description: text (ä»»åŠ¡æè¿°)
  status: varchar (ä»»åŠ¡çŠ¶æ€) DEFAULT 'å¾…å¤„ç†'
    - å¯é€‰å€¼: 'å¾…å¤„ç†', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'
  priority: varchar (ä¼˜å…ˆçº§) DEFAULT 'ä¸­'
    - å¯é€‰å€¼: 'é«˜', 'ä¸­', 'ä½'
  assigned_to: integer (åˆ†é…ç»™è° â†’ employees.id)
  created_by: integer (åˆ›å»ºäºº â†’ employees.id)
  due_date: timestamptz (æˆªæ­¢æ—¥æœŸ)
  completed_at: timestamptz (å®Œæˆæ—¶é—´)
  tags: text[] (æ ‡ç­¾æ•°ç»„)
  related_student_id: integer (å…³è”å­¦ç”Ÿ â†’ students.id)
  related_lead_id: integer (å…³è”çº¿ç´¢ â†’ leads.id)
  created_at: timestamptz (åˆ›å»ºæ—¶é—´)
  updated_at: timestamptz (æ›´æ–°æ—¶é—´)
}
```

#### `task_comments` è¡¨ (ä»»åŠ¡è¯„è®ºè¡¨)
```sql
task_comments {
  id: integer (ä¸»é”®)
  task_id: integer (ä»»åŠ¡ID â†’ tasks.id)
  employee_id: integer (è¯„è®ºäºº â†’ employees.id)
  content: text (è¯„è®ºå†…å®¹) *å¿…å¡«
  created_at: timestamptz (åˆ›å»ºæ—¶é—´)
}
```

### 2. **ä»»åŠ¡æœåŠ¡ (taskService.ts)**

å·²åˆ›å»ºå®Œæ•´çš„ä»»åŠ¡ç®¡ç†æœåŠ¡,åŒ…å«ä»¥ä¸‹åŠŸèƒ½:

#### æ ¸å¿ƒCRUDæ“ä½œ
- `getAllTasks()` - è·å–æ‰€æœ‰ä»»åŠ¡
- `getTasksByStatus(status)` - æŒ‰çŠ¶æ€ç­›é€‰ä»»åŠ¡
- `getTasksByAssignee(employeeId)` - è·å–æŒ‡å®šäººå‘˜çš„ä»»åŠ¡
- `getTaskById(taskId)` - è·å–å•ä¸ªä»»åŠ¡è¯¦æƒ…
- `createTask(taskData)` - åˆ›å»ºæ–°ä»»åŠ¡
- `updateTask(taskId, taskData)` - æ›´æ–°ä»»åŠ¡
- `deleteTask(taskId)` - åˆ é™¤ä»»åŠ¡
- `updateTaskStatus(taskId, status)` - æ›´æ–°ä»»åŠ¡çŠ¶æ€

#### è¯„è®ºåŠŸèƒ½
- `getTaskComments(taskId)` - è·å–ä»»åŠ¡è¯„è®º
- `addTaskComment(taskId, content)` - æ·»åŠ è¯„è®º

#### è¾…åŠ©åŠŸèƒ½
- `getTaskStats()` - è·å–ä»»åŠ¡ç»Ÿè®¡æ•°æ®
- `searchTasks(keyword)` - æœç´¢ä»»åŠ¡

## ğŸš€ å¦‚ä½•é›†æˆåˆ°ç°æœ‰é¡µé¢

### æ–¹æ¡ˆä¸€: ä¿®æ”¹ç°æœ‰ TaskManagementPage.tsx

éœ€è¦å°†ç¡¬ç¼–ç çš„æ•°æ®æ›¿æ¢ä¸º Supabase æ•°æ®:

```typescript
import taskService, { Task } from '../../services/taskService';

const TaskManagementPage: React.FC = () => {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);

  // åŠ è½½ä»»åŠ¡åˆ—è¡¨
  useEffect(() => {
    loadTasks();
  }, []);

  const loadTasks = async () => {
    try {
      setLoading(true);
      const data = await taskService.getAllTasks();
      setTasks(data);
    } catch (error) {
      console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  // åˆ›å»ºä»»åŠ¡
  const handleCreateTask = async (taskData) => {
    try {
      await taskService.createTask(taskData);
      loadTasks(); // é‡æ–°åŠ è½½
    } catch (error) {
      console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
    }
  };

  // æ›´æ–°ä»»åŠ¡çŠ¶æ€
  const handleUpdateStatus = async (taskId, status) => {
    try {
      await taskService.updateTaskStatus(taskId, status);
      loadTasks();
    } catch (error) {
      console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
    }
  };

  // åˆ é™¤ä»»åŠ¡
  const handleDeleteTask = async (taskId) => {
    try {
      await taskService.deleteTask(taskId);
      loadTasks();
    } catch (error) {
      console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
    }
  };
}
```

### æ–¹æ¡ˆäºŒ: åˆ›å»ºç®€åŒ–ç‰ˆä»»åŠ¡ç®¡ç†é¡µé¢

åˆ›å»ºä¸€ä¸ªæ–°çš„ç®€æ´ç‰ˆä»»åŠ¡ç®¡ç†é¡µé¢:

```typescript
// src/pages/admin/SimpleTaskPage.tsx
import React, { useState, useEffect } from 'react';
import taskService, { Task, CreateTaskForm } from '../../services/taskService';

const SimpleTaskPage: React.FC = () => {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);
  const [filterStatus, setFilterStatus] = useState<string>('all');

  useEffect(() => {
    loadTasks();
  }, [filterStatus]);

  const loadTasks = async () => {
    try {
      setLoading(true);
      const data = filterStatus === 'all'
        ? await taskService.getAllTasks()
        : await taskService.getTasksByStatus(filterStatus);
      setTasks(data);
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">ä»»åŠ¡ç®¡ç†</h1>
      
      {/* çŠ¶æ€ç­›é€‰ */}
      <div className="mb-4 flex gap-2">
        {['all', 'å¾…å¤„ç†', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'].map(status => (
          <button
            key={status}
            onClick={() => setFilterStatus(status)}
            className={`px-4 py-2 rounded ${
              filterStatus === status ? 'bg-blue-500 text-white' : 'bg-gray-200'
            }`}
          >
            {status === 'all' ? 'å…¨éƒ¨' : status}
          </button>
        ))}
      </div>

      {/* ä»»åŠ¡åˆ—è¡¨ */}
      {loading ? (
        <div>åŠ è½½ä¸­...</div>
      ) : (
        <div className="space-y-4">
          {tasks.map(task => (
            <div key={task.id} className="bg-white p-4 rounded shadow">
              <h3 className="font-bold">{task.title}</h3>
              <p className="text-gray-600">{task.description}</p>
              <div className="mt-2 flex gap-2">
                <span className={`px-2 py-1 rounded text-xs ${
                  task.priority === 'é«˜' ? 'bg-red-100 text-red-700' :
                  task.priority === 'ä¸­' ? 'bg-yellow-100 text-yellow-700' :
                  'bg-green-100 text-green-700'
                }`}>
                  {task.priority}
                </span>
                <span className="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
                  {task.status}
                </span>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default SimpleTaskPage;
```

## ğŸ“Š API ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–æ‰€æœ‰ä»»åŠ¡
```typescript
const tasks = await taskService.getAllTasks();
// è¿”å›åŒ…å«è´Ÿè´£äººã€åˆ›å»ºäººã€å­¦ç”Ÿã€çº¿ç´¢å…³è”ä¿¡æ¯çš„ä»»åŠ¡åˆ—è¡¨
```

### 2. åˆ›å»ºä»»åŠ¡
```typescript
const newTask = await taskService.createTask({
  title: 'è”ç³»å®¢æˆ·',
  description: 'è·Ÿè¿›ä¸Šå‘¨çš„å’¨è¯¢å®¢æˆ·',
  assigned_to: 1, // å‘˜å·¥ID
  priority: 'é«˜',
  due_date: '2025-10-25',
  tags: ['é”€å”®', 'è·Ÿè¿›'],
  related_lead_id: 5, // å…³è”çº¿ç´¢ID
});
```

### 3. æ›´æ–°ä»»åŠ¡çŠ¶æ€
```typescript
await taskService.updateTaskStatus(taskId, 'å·²å®Œæˆ');
// è‡ªåŠ¨è®°å½•å®Œæˆæ—¶é—´
```

### 4. æ·»åŠ è¯„è®º
```typescript
await taskService.addTaskComment(taskId, 'å·²å®Œæˆå®¢æˆ·æ²Ÿé€š');
```

### 5. æœç´¢ä»»åŠ¡
```typescript
const results = await taskService.searchTasks('å®¢æˆ·');
// æœç´¢æ ‡é¢˜å’Œæè¿°ä¸­åŒ…å«"å®¢æˆ·"çš„ä»»åŠ¡
```

### 6. è·å–ç»Ÿè®¡æ•°æ®
```typescript
const stats = await taskService.getTaskStats();
// è¿”å›: { total, pending, inProgress, completed, canceled, high, medium, low }
```

## ğŸ¯ æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·æ“ä½œ
    â†“
TaskManagementPage.tsx (UIå±‚)
    â†“
taskService.ts (ä¸šåŠ¡é€»è¾‘å±‚)
    â†“
Supabase Client (æ•°æ®è®¿é—®å±‚)
    â†“
Supabase Database (æ•°æ®å­˜å‚¨å±‚)
    - tasks è¡¨
    - task_comments è¡¨
    - employees è¡¨ (å…³è”)
    - students è¡¨ (å…³è”)
    - leads è¡¨ (å…³è”)
```

## ğŸ” æƒé™å’Œå®‰å…¨

### å½“å‰ç”¨æˆ·è¯†åˆ«
```typescript
// ä» localStorage è·å–å½“å‰ç™»å½•ç”¨æˆ·
const currentEmployee = localStorage.getItem('currentEmployee');
const userId = JSON.parse(currentEmployee).id;
```

### è‡ªåŠ¨è®¾ç½®åˆ›å»ºäºº
```typescript
// taskService.createTask() è‡ªåŠ¨ä» localStorage è·å–åˆ›å»ºäººID
created_by: currentEmployee ? JSON.parse(currentEmployee).id : null
```

## ğŸ“ å­—æ®µæ˜ å°„å¯¹æ¯”

### æ—§ç‰ˆ (ç¡¬ç¼–ç ) vs æ–°ç‰ˆ (Supabase)

| æ—§å­—æ®µ | æ–°å­—æ®µ | ç±»å‹è½¬æ¢ |
|--------|--------|----------|
| `id: string` | `id: number` | æ”¹ä¸ºæ•°å­— |
| `assignees: []` (å¤šäºº) | `assigned_to: number` (å•äºº) | ç®€åŒ–ä¸ºå•è´Ÿè´£äºº |
| `status: 'pending'` | `status: 'å¾…å¤„ç†'` | æ”¹ä¸ºä¸­æ–‡ |
| `status: 'in_progress'` | `status: 'è¿›è¡Œä¸­'` | |
| `status: 'completed'` | `status: 'å·²å®Œæˆ'` | |
| `status: 'canceled'` | `status: 'å·²å–æ¶ˆ'` | |
| `priority: 'low'` | `priority: 'ä½'` | æ”¹ä¸ºä¸­æ–‡ |
| `priority: 'medium'` | `priority: 'ä¸­'` | |
| `priority: 'high'` | `priority: 'é«˜'` | |
| `priority: 'urgent'` | - | ç§»é™¤urgent,åˆå¹¶åˆ°é«˜ |
| `dueDate` | `due_date` | é©¼å³°æ”¹ä¸‹åˆ’çº¿ |
| `createdAt` | `created_at` | |
| `updatedAt` | `updated_at` | |

## ğŸ¨ UI å»ºè®®

### çŠ¶æ€é¢œè‰²
```typescript
const statusColors = {
  'å¾…å¤„ç†': 'bg-gray-100 text-gray-700',
  'è¿›è¡Œä¸­': 'bg-blue-100 text-blue-700',
  'å·²å®Œæˆ': 'bg-green-100 text-green-700',
  'å·²å–æ¶ˆ': 'bg-red-100 text-red-700',
};

const priorityColors = {
  'é«˜': 'bg-red-100 text-red-700',
  'ä¸­': 'bg-yellow-100 text-yellow-700',
  'ä½': 'bg-green-100 text-green-700',
};
```

### å›¾æ ‡å»ºè®®
```typescript
const statusIcons = {
  'å¾…å¤„ç†': <Circle />,
  'è¿›è¡Œä¸­': <Clock />,
  'å·²å®Œæˆ': <CheckCircle2 />,
  'å·²å–æ¶ˆ': <XCircle />,
};
```

## ğŸš§ éœ€è¦æ³¨æ„çš„é—®é¢˜

### 1. æ•°æ®ç±»å‹è½¬æ¢
- IDä»å­—ç¬¦ä¸²æ”¹ä¸ºæ•°å­—
- çŠ¶æ€å’Œä¼˜å…ˆçº§ä»è‹±æ–‡æ”¹ä¸ºä¸­æ–‡
- æ—¥æœŸæ ¼å¼éœ€è¦è½¬æ¢

### 2. å•è´Ÿè´£äºº vs å¤šè´Ÿè´£äºº
- æ•°æ®åº“åªæ”¯æŒå•è´Ÿè´£äºº (`assigned_to`)
- å¦‚éœ€å¤šè´Ÿè´£äºº,éœ€è¦ä¿®æ”¹æ•°æ®åº“ç»“æ„æ·»åŠ å…³è”è¡¨

### 3. å…³è”æ•°æ®
- ä»»åŠ¡å¯ä»¥å…³è”å­¦ç”Ÿ (`related_student_id`)
- ä»»åŠ¡å¯ä»¥å…³è”çº¿ç´¢ (`related_lead_id`)
- éœ€è¦ç¡®ä¿è¿™äº›IDå­˜åœ¨

## ğŸ“¦ å¿«é€Ÿæµ‹è¯•

### æµ‹è¯•åˆ›å»ºä»»åŠ¡
```typescript
import taskService from './services/taskService';

// åˆ›å»ºæµ‹è¯•ä»»åŠ¡
const testTask = await taskService.createTask({
  title: 'æµ‹è¯•ä»»åŠ¡',
  description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡',
  priority: 'é«˜',
  due_date: new Date().toISOString(),
});

console.log('ä»»åŠ¡åˆ›å»ºæˆåŠŸ:', testTask);
```

### æµ‹è¯•è·å–ä»»åŠ¡
```typescript
const tasks = await taskService.getAllTasks();
console.log('ä»»åŠ¡åˆ—è¡¨:', tasks);

const stats = await taskService.getTaskStats();
console.log('ç»Ÿè®¡æ•°æ®:', stats);
```

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆ
- âœ… åˆ›å»ºå®Œæ•´çš„ `taskService.ts`
- âœ… è¿æ¥åˆ° Supabase `tasks` å’Œ `task_comments` è¡¨
- âœ… å®ç°æ‰€æœ‰CRUDæ“ä½œ
- âœ… å®ç°è¯„è®ºåŠŸèƒ½
- âœ… å®ç°æœç´¢å’Œç»Ÿè®¡
- âœ… è‡ªåŠ¨å…³è”å‘˜å·¥ã€å­¦ç”Ÿã€çº¿ç´¢æ•°æ®

### ä¸‹ä¸€æ­¥
- ğŸ”„ é›†æˆåˆ°ç°æœ‰ `TaskManagementPage.tsx`
- ğŸ”„ æˆ–åˆ›å»ºæ–°çš„ç®€åŒ–ç‰ˆé¡µé¢
- ğŸ”„ æ·»åŠ è¡¨å•éªŒè¯
- ğŸ”„ æ·»åŠ åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
- ğŸ”„ å®ç°å®æ—¶æ›´æ–°(å¯é€‰)

---

**åˆ›å»ºæ—¶é—´**: 2025-10-20  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… æœåŠ¡å±‚å·²å®Œæˆ,ç­‰å¾…UIé›†æˆ

