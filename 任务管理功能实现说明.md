# 任务管理功能 - Supabase 实现说明

## ✅ 已创建的内容

### 1. **Supabase 数据库表结构**

#### `tasks` 表 (任务主表)
```sql
tasks {
  id: integer (主键)
  title: varchar (任务标题) *必填
  description: text (任务描述)
  status: varchar (任务状态) DEFAULT '待处理'
    - 可选值: '待处理', '进行中', '已完成', '已取消'
  priority: varchar (优先级) DEFAULT '中'
    - 可选值: '高', '中', '低'
  assigned_to: integer (分配给谁 → employees.id)
  created_by: integer (创建人 → employees.id)
  due_date: timestamptz (截止日期)
  completed_at: timestamptz (完成时间)
  tags: text[] (标签数组)
  related_student_id: integer (关联学生 → students.id)
  related_lead_id: integer (关联线索 → leads.id)
  created_at: timestamptz (创建时间)
  updated_at: timestamptz (更新时间)
}
```

#### `task_comments` 表 (任务评论表)
```sql
task_comments {
  id: integer (主键)
  task_id: integer (任务ID → tasks.id)
  employee_id: integer (评论人 → employees.id)
  content: text (评论内容) *必填
  created_at: timestamptz (创建时间)
}
```

### 2. **任务服务 (taskService.ts)**

已创建完整的任务管理服务,包含以下功能:

#### 核心CRUD操作
- `getAllTasks()` - 获取所有任务
- `getTasksByStatus(status)` - 按状态筛选任务
- `getTasksByAssignee(employeeId)` - 获取指定人员的任务
- `getTaskById(taskId)` - 获取单个任务详情
- `createTask(taskData)` - 创建新任务
- `updateTask(taskId, taskData)` - 更新任务
- `deleteTask(taskId)` - 删除任务
- `updateTaskStatus(taskId, status)` - 更新任务状态

#### 评论功能
- `getTaskComments(taskId)` - 获取任务评论
- `addTaskComment(taskId, content)` - 添加评论

#### 辅助功能
- `getTaskStats()` - 获取任务统计数据
- `searchTasks(keyword)` - 搜索任务

## 🚀 如何集成到现有页面

### 方案一: 修改现有 TaskManagementPage.tsx

需要将硬编码的数据替换为 Supabase 数据:

```typescript
import taskService, { Task } from '../../services/taskService';

const TaskManagementPage: React.FC = () => {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);

  // 加载任务列表
  useEffect(() => {
    loadTasks();
  }, []);

  const loadTasks = async () => {
    try {
      setLoading(true);
      const data = await taskService.getAllTasks();
      setTasks(data);
    } catch (error) {
      console.error('加载任务失败:', error);
    } finally {
      setLoading(false);
    }
  };

  // 创建任务
  const handleCreateTask = async (taskData) => {
    try {
      await taskService.createTask(taskData);
      loadTasks(); // 重新加载
    } catch (error) {
      console.error('创建任务失败:', error);
    }
  };

  // 更新任务状态
  const handleUpdateStatus = async (taskId, status) => {
    try {
      await taskService.updateTaskStatus(taskId, status);
      loadTasks();
    } catch (error) {
      console.error('更新状态失败:', error);
    }
  };

  // 删除任务
  const handleDeleteTask = async (taskId) => {
    try {
      await taskService.deleteTask(taskId);
      loadTasks();
    } catch (error) {
      console.error('删除任务失败:', error);
    }
  };
}
```

### 方案二: 创建简化版任务管理页面

创建一个新的简洁版任务管理页面:

```typescript
// src/pages/admin/SimpleTaskPage.tsx
import React, { useState, useEffect } from 'react';
import taskService, { Task, CreateTaskForm } from '../../services/taskService';

const SimpleTaskPage: React.FC = () => {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);
  const [filterStatus, setFilterStatus] = useState<string>('all');

  useEffect(() => {
    loadTasks();
  }, [filterStatus]);

  const loadTasks = async () => {
    try {
      setLoading(true);
      const data = filterStatus === 'all'
        ? await taskService.getAllTasks()
        : await taskService.getTasksByStatus(filterStatus);
      setTasks(data);
    } catch (error) {
      console.error('加载失败:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">任务管理</h1>
      
      {/* 状态筛选 */}
      <div className="mb-4 flex gap-2">
        {['all', '待处理', '进行中', '已完成', '已取消'].map(status => (
          <button
            key={status}
            onClick={() => setFilterStatus(status)}
            className={`px-4 py-2 rounded ${
              filterStatus === status ? 'bg-blue-500 text-white' : 'bg-gray-200'
            }`}
          >
            {status === 'all' ? '全部' : status}
          </button>
        ))}
      </div>

      {/* 任务列表 */}
      {loading ? (
        <div>加载中...</div>
      ) : (
        <div className="space-y-4">
          {tasks.map(task => (
            <div key={task.id} className="bg-white p-4 rounded shadow">
              <h3 className="font-bold">{task.title}</h3>
              <p className="text-gray-600">{task.description}</p>
              <div className="mt-2 flex gap-2">
                <span className={`px-2 py-1 rounded text-xs ${
                  task.priority === '高' ? 'bg-red-100 text-red-700' :
                  task.priority === '中' ? 'bg-yellow-100 text-yellow-700' :
                  'bg-green-100 text-green-700'
                }`}>
                  {task.priority}
                </span>
                <span className="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
                  {task.status}
                </span>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default SimpleTaskPage;
```

## 📊 API 使用示例

### 1. 获取所有任务
```typescript
const tasks = await taskService.getAllTasks();
// 返回包含负责人、创建人、学生、线索关联信息的任务列表
```

### 2. 创建任务
```typescript
const newTask = await taskService.createTask({
  title: '联系客户',
  description: '跟进上周的咨询客户',
  assigned_to: 1, // 员工ID
  priority: '高',
  due_date: '2025-10-25',
  tags: ['销售', '跟进'],
  related_lead_id: 5, // 关联线索ID
});
```

### 3. 更新任务状态
```typescript
await taskService.updateTaskStatus(taskId, '已完成');
// 自动记录完成时间
```

### 4. 添加评论
```typescript
await taskService.addTaskComment(taskId, '已完成客户沟通');
```

### 5. 搜索任务
```typescript
const results = await taskService.searchTasks('客户');
// 搜索标题和描述中包含"客户"的任务
```

### 6. 获取统计数据
```typescript
const stats = await taskService.getTaskStats();
// 返回: { total, pending, inProgress, completed, canceled, high, medium, low }
```

## 🎯 数据流程图

```
用户操作
    ↓
TaskManagementPage.tsx (UI层)
    ↓
taskService.ts (业务逻辑层)
    ↓
Supabase Client (数据访问层)
    ↓
Supabase Database (数据存储层)
    - tasks 表
    - task_comments 表
    - employees 表 (关联)
    - students 表 (关联)
    - leads 表 (关联)
```

## 🔐 权限和安全

### 当前用户识别
```typescript
// 从 localStorage 获取当前登录用户
const currentEmployee = localStorage.getItem('currentEmployee');
const userId = JSON.parse(currentEmployee).id;
```

### 自动设置创建人
```typescript
// taskService.createTask() 自动从 localStorage 获取创建人ID
created_by: currentEmployee ? JSON.parse(currentEmployee).id : null
```

## 📝 字段映射对比

### 旧版 (硬编码) vs 新版 (Supabase)

| 旧字段 | 新字段 | 类型转换 |
|--------|--------|----------|
| `id: string` | `id: number` | 改为数字 |
| `assignees: []` (多人) | `assigned_to: number` (单人) | 简化为单负责人 |
| `status: 'pending'` | `status: '待处理'` | 改为中文 |
| `status: 'in_progress'` | `status: '进行中'` | |
| `status: 'completed'` | `status: '已完成'` | |
| `status: 'canceled'` | `status: '已取消'` | |
| `priority: 'low'` | `priority: '低'` | 改为中文 |
| `priority: 'medium'` | `priority: '中'` | |
| `priority: 'high'` | `priority: '高'` | |
| `priority: 'urgent'` | - | 移除urgent,合并到高 |
| `dueDate` | `due_date` | 驼峰改下划线 |
| `createdAt` | `created_at` | |
| `updatedAt` | `updated_at` | |

## 🎨 UI 建议

### 状态颜色
```typescript
const statusColors = {
  '待处理': 'bg-gray-100 text-gray-700',
  '进行中': 'bg-blue-100 text-blue-700',
  '已完成': 'bg-green-100 text-green-700',
  '已取消': 'bg-red-100 text-red-700',
};

const priorityColors = {
  '高': 'bg-red-100 text-red-700',
  '中': 'bg-yellow-100 text-yellow-700',
  '低': 'bg-green-100 text-green-700',
};
```

### 图标建议
```typescript
const statusIcons = {
  '待处理': <Circle />,
  '进行中': <Clock />,
  '已完成': <CheckCircle2 />,
  '已取消': <XCircle />,
};
```

## 🚧 需要注意的问题

### 1. 数据类型转换
- ID从字符串改为数字
- 状态和优先级从英文改为中文
- 日期格式需要转换

### 2. 单负责人 vs 多负责人
- 数据库只支持单负责人 (`assigned_to`)
- 如需多负责人,需要修改数据库结构添加关联表

### 3. 关联数据
- 任务可以关联学生 (`related_student_id`)
- 任务可以关联线索 (`related_lead_id`)
- 需要确保这些ID存在

## 📦 快速测试

### 测试创建任务
```typescript
import taskService from './services/taskService';

// 创建测试任务
const testTask = await taskService.createTask({
  title: '测试任务',
  description: '这是一个测试任务',
  priority: '高',
  due_date: new Date().toISOString(),
});

console.log('任务创建成功:', testTask);
```

### 测试获取任务
```typescript
const tasks = await taskService.getAllTasks();
console.log('任务列表:', tasks);

const stats = await taskService.getTaskStats();
console.log('统计数据:', stats);
```

## 🎉 总结

### 已完成
- ✅ 创建完整的 `taskService.ts`
- ✅ 连接到 Supabase `tasks` 和 `task_comments` 表
- ✅ 实现所有CRUD操作
- ✅ 实现评论功能
- ✅ 实现搜索和统计
- ✅ 自动关联员工、学生、线索数据

### 下一步
- 🔄 集成到现有 `TaskManagementPage.tsx`
- 🔄 或创建新的简化版页面
- 🔄 添加表单验证
- 🔄 添加加载状态和错误处理
- 🔄 实现实时更新(可选)

---

**创建时间**: 2025-10-20  
**版本**: v1.0  
**状态**: ✅ 服务层已完成,等待UI集成

