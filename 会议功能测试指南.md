# 会议功能测试指南

## 🧪 完整测试流程

### 前提条件

1. ✅ 迁移1已执行（task_domain等字段）
2. ✅ 迁移2已执行（meeting_id字段）
3. ⚠️ 迁移3需要执行（状态同步触发器）

---

## 📋 测试清单

### 第1步：执行迁移3（5分钟）

访问 Supabase SQL Editor 并执行：

```sql
-- 创建同步函数和触发器
CREATE OR REPLACE FUNCTION sync_meeting_status_on_task_completion()
RETURNS TRIGGER AS $$
DECLARE
  related_meeting_id INTEGER;
  total_tasks INTEGER;
  completed_tasks INTEGER;
  cancelled_tasks INTEGER;
  in_progress_tasks INTEGER;
BEGIN
  related_meeting_id := NEW.meeting_id;
  
  IF related_meeting_id IS NULL THEN
    RETURN NEW;
  END IF;
  
  SELECT 
    COUNT(*),
    COUNT(CASE WHEN status = '已完成' THEN 1 END),
    COUNT(CASE WHEN status = '已取消' THEN 1 END),
    COUNT(CASE WHEN status = '进行中' THEN 1 END)
  INTO total_tasks, completed_tasks, cancelled_tasks, in_progress_tasks
  FROM tasks
  WHERE meeting_id = related_meeting_id;
  
  IF total_tasks > 0 THEN
    IF completed_tasks = total_tasks THEN
      UPDATE meetings SET status = '已完成', updated_at = NOW()
      WHERE id = related_meeting_id AND status != '已完成';
    ELSIF cancelled_tasks = total_tasks THEN
      UPDATE meetings SET status = '已取消', updated_at = NOW()
      WHERE id = related_meeting_id AND status != '已取消';
    ELSIF in_progress_tasks > 0 THEN
      UPDATE meetings SET status = '进行中', updated_at = NOW()
      WHERE id = related_meeting_id AND status NOT IN ('进行中', '已完成');
    END IF;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_sync_meeting_status ON tasks;
CREATE TRIGGER trigger_sync_meeting_status
AFTER INSERT OR UPDATE OF status, meeting_id ON tasks
FOR EACH ROW
EXECUTE FUNCTION sync_meeting_status_on_task_completion();

SELECT '✅ 状态同步触发器创建成功！' as message;
```

---

### 第2步：刷新前端（30秒）

1. 硬刷新浏览器：`Cmd+Shift+R`
2. 打开任务管理页面

---

### 第3步：测试会议跳转（2分钟）

#### 测试A：创建会议并跳转

```
操作步骤：
1. 打开任意一个任务
2. 在侧边栏点击"创建会议"
3. 填写会议信息并创建
4. 等待会议创建成功（应该看到会议信息显示）
5. 在会议卡片右上角找到 ↗ 按钮
6. 点击按钮

预期结果：
✅ 自动跳转到会议详情页
✅ URL变为 /admin/meetings/会议ID
✅ 显示完整会议信息
```

#### 测试B：关联已有会议并跳转

```
操作步骤：
1. 打开另一个任务
2. 点击"关联会议"区域
3. 从下拉列表选择一个已有会议
4. 保存
5. 点击 ↗ 跳转按钮

预期结果：
✅ 跳转到会议详情页
✅ 显示选中的会议信息
```

---

### 第4步：测试状态自动同步（5分钟）

#### 准备工作

1. 创建一个新会议（或使用已有会议）
2. 创建2个任务
3. 将这2个任务都关联到同一个会议
4. 确认会议状态为"待举行"

#### 测试流程

**步骤1：完成第一个任务**
```
操作：
- 打开任务1
- 状态改为"已完成"
- 保存

检查：
- 打开会议管理页面
- 查看该会议状态
- 应该是"进行中"（因为还有任务未完成）
```

**步骤2：完成第二个任务**
```
操作：
- 返回任务管理
- 打开任务2
- 状态改为"已完成"
- 保存

检查：
- 打开会议管理页面
- 查看该会议状态
- ✅ 应该自动变为"已完成"！
```

**步骤3：验证同步**
```
验证点：
1. 会议状态确实是"已完成" ✅
2. 没有手动修改会议状态
3. 完全由触发器自动完成
4. updated_at 时间是最后一个任务完成的时间
```

---

### 第5步：测试边界情况（3分钟）

#### 测试C：部分任务完成

```
场景：会议有3个任务

操作：
1. 任务1: 已完成 ✅
2. 任务2: 进行中 🔄
3. 任务3: 待处理 ⏰

预期：
会议状态: "进行中" ✅
原因: 有任务正在执行
```

#### 测试D：全部取消

```
场景：会议有2个任务

操作：
1. 任务1: 改为"已取消"
2. 任务2: 改为"已取消"

预期：
会议状态: "已取消" ✅
原因: 所有任务都取消了
```

#### 测试E：取消会议关联

```
场景：任务原本关联了会议

操作：
1. 打开任务侧边栏
2. 点击会议区域进入编辑
3. 选择"无关联会议"
4. 保存

预期：
✅ 会议关联被移除
✅ 会议徽章消失
✅ 会议状态重新计算（基于剩余任务）
```

---

## 📊 验证数据一致性

### SQL查询验证

```sql
-- 查看会议和任务的状态对应关系
SELECT 
  m.id,
  m.title as meeting_title,
  m.status as meeting_status,
  COUNT(t.id) as total_tasks,
  COUNT(CASE WHEN t.status = '已完成' THEN 1 END) as completed,
  COUNT(CASE WHEN t.status = '进行中' THEN 1 END) as in_progress,
  COUNT(CASE WHEN t.status = '待处理' THEN 1 END) as pending,
  COUNT(CASE WHEN t.status = '已取消' THEN 1 END) as cancelled
FROM meetings m
LEFT JOIN tasks t ON t.meeting_id = m.id
GROUP BY m.id, m.title, m.status
HAVING COUNT(t.id) > 0
ORDER BY m.id;
```

### 预期结果

每个会议的状态应该符合逻辑：
- completed = total_tasks → meeting_status = '已完成'
- in_progress > 0 → meeting_status = '进行中'
- cancelled = total_tasks → meeting_status = '已取消'

---

## ✅ 测试检查表

### 会议跳转功能
- [ ] ↗ 按钮显示正确
- [ ] 悬浮效果正常
- [ ] 点击跳转成功
- [ ] 跳转到正确的会议页面
- [ ] 未关联会议时按钮不显示

### 状态自动同步
- [ ] 触发器创建成功
- [ ] 完成任务时会议状态更新
- [ ] 取消任务时会议状态更新
- [ ] 混合状态处理正确
- [ ] 不会误更新其他会议

### 数据一致性
- [ ] 会议状态与任务状态对应
- [ ] updated_at 时间正确
- [ ] 无数据丢失
- [ ] 无重复更新

---

## 🎯 成功标准

### 功能1：会议跳转 ✅

- [x] 按钮显示
- [x] 点击跳转
- [x] 页面正确
- [x] 无错误提示

### 功能2：状态同步 ✅

- [ ] 触发器部署
- [ ] 自动同步工作
- [ ] 状态逻辑正确
- [ ] 边界情况处理

**如果全部通过 → 🎉 功能上线成功！**

---

**测试指南版本**: v1.0  
**创建时间**: 2025-11-02  
**预计测试时间**: 15分钟

