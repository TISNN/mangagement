# 财务子模块设计文档（Finance Suite）

> 目标：支撑运营、财务及管理层掌握机构收入/支出、现金流、应收应付及合规状况，为战略决策提供实时数据支撑。本设计涵盖“财务概览（仪表盘）”与“财务流水”两个一级功能，后续可扩展预算、发票、税务模块。

## 1. 模块定位与用户
- **模块归属**：ERP 管理 → 财务
- **用户角色**：
  - CFO / 财务总监：关注现金流、利润、风险及合规
  - 财务会计：负责日常记账、凭证审核、对账
  - 业务负责人（招生、顾问、市场）：查看项目/团队营收支出
  - 管理层：获取高层视角的 KPI、趋势、警报

## 2. 信息架构
```
Finance Suite
├─ 财务概览（仪表盘）
│  ├ KPI 摘要（收入、毛利、利润、现金缓存期）
│  ├ 收入管道与项目维度拆解
│  ├ 支出结构（固定 / 变量 / 市场 / 人力）
│  ├ 现金流预测与风险预警
│  ├ 应收应付概览 + Aging 分布
│  ├ 税务与合规提醒
│  └ 自定义视图 / 导出 / 定期报告
└─ 财务流水
   ├ 交易列表（收入、支出、转账、退款、税费）
   ├ 筛选与多维度聚合（时间、项目、合作方、渠道、科目）
   ├ 凭证及附件管理
   ├ 审批流、合规校验
   ├ 对账工具（银行、支付平台、知识花园收益）
   └ 导出、API 同步
```

## 3. 财务概览（仪表盘）功能详解
### 3.1 KPI 摘要卡片
| KPI | 指标说明 | 维度 | 交互 |
| --- | --- | --- | --- |
| 本月收入 | 确认收入（课程/知识花园/企业授权） | 支持货币切换 | 点击进入详细列表 |
| 毛利率 | 收入 - 可变成本 / 收入 | 按产品线 | Tooltip 显示对比先前周期 |
| 营业利润 | 税前利润 | 按月份 | 支持目标线展示 |
| 现金储备天数 | 可用现金 / 日均运营支出 | 按账户 | 风险低于 45 天时标红 |
| 应收账款 | 未回款金额 | 按 Aging | 点击进入应收列表 |
| 知识花园 GMV | 市场化平台流水 | 按角色/SKU | 与 CRM 联动 |

- 提供“报告比对”选择器：本月 vs 上月、本季 vs 上季、年度同比。

### 3.2 收入管道 & 解构
- **条形/柱状图**：展示按产品线（留学服务、语言课程、知识花园、企业服务）的收入贡献。
- **瀑布图**：从签约金额 → 确认收入 → 净收入 → 税费 → 净利润。
- **客户地域分布**：热力图或气泡图（Top 市场）。

### 3.3 支出结构
- **饼图 / 矩形树图**：按支出科目（人力成本、市场投放、办公、合作方分成）展示比例。
- **趋势折线**：支出 vs 预算（显示偏差）。
- **固定 vs 变量**：堆叠条形图或 KPI 标签。

### 3.4 现金流预测
- **折线图**：未来 12 周/12 月的现金流入流出预测（基于合同、订阅、应收应付）。
- **场景模拟**：切换“基准 / 保守 / 乐观”三种预测模型。
- **风险提示**：当某周现金流转负时，展示提示卡片（建议措施）。

### 3.5 应收应付概览
- **Aging 矩阵**：0-30 天、31-60 天、61-90 天、>90 天。
- **Top Outstanding**：列出最大未回款客户 / 合作方。
- **催收进度**：显示催收状态（未联系/跟进中/承诺付款/争议）。

### 3.6 税务与合规提醒
- 税期日历：增值税/企业所得税申报倒计时。
- 警报卡片：缺失的审批、合同到期、预算超支。
- 合规追踪：知识花园收益是否按政策结算、跨境收款合规状态。

### 3.7 自定义视图
- 用户可保存仪表盘布局：挑选组件、排序、设置过滤器。
- 导出 PDF、PNG、Excel；支持邮件订阅（周报/月报）。

## 4. 财务流水功能详解
### 4.1 列表视图
| 字段 | 说明 |
| --- | --- |
| 交易编号 | 系统自动生成，支持搜索 |
| 日期 | 交易发生日（支持区间查询）|
| 类型 | 收入 / 支出 / 转账 / 退款 / 税费 |
| 项目/产品 | 关联项目或知识花园 SKU |
| 金额 | 正负数区分流入/流出，显示币种 |
| 支付渠道 | 银行、支付宝、Stripe、现金等 |
| 合作方/客户 | 对应联系人及组织 |
| 状态 | 待确认 / 已核销 / 争议中 |
| 审批 | 审批流程状态（通过/驳回/待审批）|

- 支持表头拖拽、列可见性切换、快速分组。
- Row Expand 展示凭证、附件、备注与关联合同。

### 4.2 筛选与聚合
- 顶部高级筛选：时间区间、项目、客户、渠道、金额区间、审批状态。
- 快捷筛选：本周、本月、季度、待核销、待审批。
- 支持多维度聚合结果：按项目汇总收入、按渠道统计成本、按顾问提成。

### 4.3 凭证与附件
- 每条流水可上传原始凭证（发票、收据、合同）。
- 自动识别票据（OCR）并填充字段，待人工确认。
- 审批流弹窗展示审批人列表、意见、时间戳。

### 4.4 审批与合规
- 针对支出/退款/折扣交易，触发审批流程：提交 → 部门负责人 → 财务 → CFO。
- 支持审批模板、加签、驳回、重新提交。
- 合规提醒：金额超阈值/无合同/票据缺失时标红。

### 4.5 对账工具
- 银行对账：导入银行流水，对比系统记录，状态分为匹配/部分匹配/未匹配。
- 支付平台对账：对 Stripe/支付宝/微信 收入进行汇总校验。
- 知识花园收益：与知识花园 GMV 及结算记录同步。

### 4.6 导出与 API
- 可导出分页/全部数据（CSV、Excel、PDF），支持字段选择。
- 提供 API 接口：获取流水、创建交易、更新审批状态、同步凭证。
- 预约任务：每日/每周定时导出到 S3/邮件。

## 5. 数据模型草案
- `FinanceTransaction`
  - `id`, `type`, `occurred_at`, `amount`, `currency`, `project_id`, `channel`, `counterparty`, `status`, `approval_state`, `notes`
- `FinanceTransactionItem`（多项目拆分）
  - `transaction_id`, `ledger_account`, `amount`
- `DocumentAttachment`
  - `transaction_id`, `file_url`, `ocr_status`, `checksum`
- `ApprovalWorkflow`
  - `resource_type`, `resource_id`, `step`, `approver_id`, `status`, `comment`, `timestamp`
- `CashflowForecast`
  - `date`, `cash_in`, `cash_out`, `scenario`, `assumption`
- `AgingRecord`
  - `customer_id`, `amount`, `bucket`, `last_follow_up`

## 6. API 草案
| 功能 | Method | Endpoint | 说明 |
| --- | --- | --- | --- |
| 获取财务 KPI | GET | `/api/finance/dashboard` | 支持时间/项目过滤 |
| 获取现金流预测 | GET | `/api/finance/cashflow` | scenario 参数（base/conservative/optimistic）|
| 获取流水列表 | GET | `/api/finance/transactions` | 高级过滤、分页 |
| 创建流水 | POST | `/api/finance/transactions` | 收入/支出/退款等 |
| 上传凭证 | POST | `/api/finance/transactions/:id/attachments` | 上传文件与 OCR |
| 审批操作 | POST | `/api/finance/transactions/:id/approve` | 审批/驳回 |
| 对账 | POST | `/api/finance/reconcile` | 上传银行或平台对账单 |
| 导出 | POST | `/api/finance/transactions/export` | 异步导出，返回下载链接 |

## 7. 权限与安全
- 角色权限：CFO（全权）、财务会计（可编辑流水）、业务负责人（只读项目数据）、审计/法务（访问日志、导出）
- 数据隔离：不同事业部按项目/区域进行权限控制。
- 审计日志：记录每次修改、审批、导出操作，支持回溯。
- 合规：对跨境收款、税务申报需提供额外验证与安全加密。

## 8. 交互与体验
- 仪表盘组件支持拖拽排序、收藏在“我的视图”。
- 流水列表支持保存视图（如“待审批”“知识花园收入”）。
- 对账结果可一键生成调整凭证。
- 关键 KPI 提供移动端迷你视图（供管理层快速查看）。

## 9. 指标与监控
- 业务指标：收入增长率、现金流转正率、应收回款周期、知识花园 GMV、成本率。
- 运营指标：审批 SLA、对账完成率、票据合规率。
- 系统指标：API 延迟、导出成功率、任务队列状态。

## 10. 迭代路线
1. **MVP**：
   - 仪表盘核心 KPI、现金流预测基础版、流水列表 + 导出
   - 审批流（简单步骤）、附件上传、银行对账导入
2. **阶段二**：
   - 自定义仪表盘视图、预算对比、税务提醒、知识花园收益联动
   - 高级审批模板、AI OCR 与自动分类
3. **阶段三**：
   - 预测优化（AI 场景）、跨币种汇率管理、ERP/会计系统 API 接口
   - 风险预警引擎（异常检测、现金流崩溃预测）
4. **阶段四**：
   - 数据仓库联动、报表自动化、大屏展示、移动端管理

---
本设计为财务子模块提供了完整蓝图，可作为产品、设计和工程团队的实现依据。