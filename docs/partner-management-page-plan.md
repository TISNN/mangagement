# 合作方管理页面方案

## 1. 背景与目标
- 老师和机构在做项目时，需要和很多合作方（其他学校、导师、培训机构、实验室等）保持联系，但目前缺少统一的管理页面。
- 目标是提供一个简单的后台页面，让老师可以“一眼看到所有合作方”“快速找到联系人”“记录合作进展”。
- 页面将放在后台导航 `/admin/partner-management`，分为“合作方列表”与“合作方详情”两级。

## 2. 主要用户与任务
| 用户 | 核心任务 |
| --- | --- |
| 顾问老师 | 按类型筛选合作方、查看联系人、发起合作请求、记录沟通 |
| 机构运营 | 维护合作方档案、跟踪合作状态、设置提醒 |
| 校方/外部伙伴（间接） | 被老师邀请，共享最新资料或需求 |

## 3. 核心价值
1. **集中管理**：所有合作方数据集中在一个页面，避免零散微信/Excel。
2. **快速联动**：与教授库、学校库、项目库互相链接，形成完整档案。
3. **过程可视**：跟进记录、提醒和责任人一目了然。

## 4. 页面信息架构
```
合作方管理
├─ 顶部概览卡片（总数、新增、活跃、即将到期）
├─ 列表区
│  ├─ 筛选条（类型、合作状态、国家/地区、合作等级、标签）
│  ├─ 表格行（名称 | 类型 | 主要联系人 | 当前合作内容 | 下一步动作 | 负责人）
│  └─ 右侧收藏/优先处理抽屉（可收起）
└─ 详情抽屉 / 全页面
   ├─ 基础信息（logo、官网、简介、标签）
   ├─ 联系方式（主负责人 + 其他联系人）
   ├─ 合作范围（合作项目、签约状态、服务品类）
   ├─ 跟进时间线（沟通记录、文件、提醒）
   ├─ 关联资源（关联教授、学校、学生案例、任务）
   └─ 内部备注与风险提示
```

## 5. 功能拆解
### 5.1 列表页
- **筛选与搜索**：支持关键字、类型（学校/导师/机构/企业）、合作状态（洽谈中/签约中/执行中/暂停/结束）、地区、标签、负责顾问。
- **多视图**：默认表格视图；可切换卡片视图（用于移动/窄屏）。
- **快捷操作**：每行提供“查看详情”“发消息/邮件”“添加跟进”“标记优先”。
- **批量操作**：多选后能批量分配负责人、批量添加标签、导出 CSV。
- **收藏抽屉**：放置重点合作方，点击星标加入，抽屉支持拖拽排序。

### 5.2 详情页/抽屉
- **基础档案**：展示 logo、合作方类型、地区、评分、合作等级、主要服务领域。
- **联系人模块**：主联系人 + 备用联系人，记录邮箱、电话、微信、LinkedIn、办公地址。
- **合作内容**：正在进行的项目列表，包含项目名称、学生/项目负责人、里程碑、当前状态。
- **合同与文件**：显示最近一次合同、生效时间、附件下载、提醒到期。
- **跟进时间线**：交互与 CRM 一致，可添加记录（时间、方式、摘要、下次动作、文件）。
- **提醒与任务**：支持设置提醒（短信/邮件/站内），并可挂接任务中心。
- **关联资源**：引用教授库、学校库、学生案例，提供跳转。
- **风险提示**：如付款逾期、合作暂停、历史争议等。

### 5.3 新建/编辑弹窗
- 三步表单：基础信息 → 联系方式 → 合作信息。
- 表单字段校验（邮箱格式、网址必带协议等），保存后刷新列表并提示成功。

## 6. 数据结构建议
### 6.1 `partners` 表（示例）
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` | uuid | 主键 |
| `name` | text | 合作方名称 |
| `type` | enum(`university`,`professor`,`agency`,`company`,`other`) | 合作类型 |
| `logo_url` | text | logo |
| `country` / `city` | text | 地理信息 |
| `website` | text | 官网链接 |
| `summary` | text | 简介 |
| `rating` | int | 合作评分 (1-5) |
| `level` | enum(`战略`,`重点`,`普通`,`观察`) | 合作等级 |
| `status` | enum(`prospecting`,`negotiating`,`active`,`on_hold`,`closed`) | 状态 |
| `tags` | text[] | 自定义标签 |
| `owner_id` | uuid | 负责人 |
| `created_at` / `updated_at` | timestamptz | 记录时间 |

### 6.2 `partner_contacts`
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `partner_id` | uuid | 外键 |
| `name` | text | 联系人 |
| `role` | text | 职位 |
| `email` / `phone` / `wechat` / `linkedin` | text | 联系方式 |
| `is_primary` | bool | 是否主联系人 |

### 6.3 `partner_engagements`
- 记录合作项目、合同、下一步动作。

### 6.4 `partner_timelines`
- 跟进记录，字段包含 `note_type`、`content`、`next_action`, `attachments`.

## 7. API & 服务
| 功能 | 方法 | 说明 |
| --- | --- | --- |
| 获取列表 | `GET /edge/partners?type=&status=&tags=` | 支持分页、排序（最近更新、合作等级） |
| 获取详情 | `GET /edge/partners/{id}` | 返回全部子模块 |
| 新建合作方 | `POST /edge/partners` | 表单提交 |
| 更新合作方 | `PATCH /edge/partners/{id}` | 只改动差异字段 |
| 添加联系人 | `POST /edge/partners/{id}/contacts` | ... |
| 添加跟进记录 | `POST /edge/partners/{id}/timeline` | 支持附件上传 |
| 收藏/取消收藏 | `POST /edge/partners/{id}/favorite` | 与本地/服务器同步 |

后端需要校验权限：仅管理员或被授权的顾问可编辑。

## 8. 权限与提醒
- **角色**：超级管理员（全部权限）、机构管理员（同机构）、顾问老师（只看负责或共享合作方）、观阅角色（只读）。
- **提醒**：
  - 合同到期前 15/7/1 天提醒负责人
  - 超过 30 天无跟进的合作方需要提示
  - 新增合作方自动通知指定运营群

## 9. 空状态与加载
- 无数据：显示“还没有合作方，点击创建”并附带示例截图。
- 网络错误：展示“加载失败，点击重试”+ 复制错误 ID。
- 骨架屏：列表和详情都提供骨架组件，保持体验一致。

## 10. 埋点与监控
- `partner_list_view`：打开页面
- `partner_filter_apply`：筛选器使用
- `partner_detail_open`：查看详情
- `partner_followup_add`：新增跟进
- `partner_reminder_trigger`：提醒触发
- 错误监控：Edge Function 返回 4xx/5xx 时记录日志并上报 Sentry。

## 11. 发布节奏
1. **迭代1（1 周）**：静态页面 + mock 数据、基础筛选。
2. **迭代2（1-2 周）**：接入 Supabase + 联系人/跟进记录写入。
3. **迭代3（1 周）**：提醒、收藏抽屉、批量操作、埋点。

## 12. 验收清单
- 列表加载 500 条内保持 <1.5s。
- 新建合作方流程全程可达，字段校验正确。
- 跟进记录支持富文本/附件，且刷新后仍可见。
- 权限隔离生效：非负责人无法编辑。
- 移动端 ≥ 1280px 自适应，无强制横向滚动。

## 13. 原型图说明
> 采用低保真线框描述，方便设计师在 Figma 中快速实现；以下 ASCII 仅表示区域关系。

### 13.1 桌面列表视图（1920px）
```
┌──────────────────────────────────────────────────────────────┐
│ 顶部四张统计卡：总合作方 / 本周新增 / 活跃中 / 即将到期         │
├──────────────────────────────────────────────────────────────┤
│ 筛选条：搜索框 | 类型 | 状态 | 地区 | 标签 | 负责人 | 重置按钮   │
├───────────────┬──────────────────────────────────────────────┤
│ 列表（表格）   │ 右侧抽屉：重点合作方（可折叠）                │
│ ┌────────────┐│ ┌────────────┐                                │
│ │名称 | 类型 ││ │星标列表卡│                                │
│ │联系人      ││ │拖拽排序  │                                │
│ │合作内容    ││ │快捷操作  │                                │
│ │下一步动作  ││ └────────────┘                                │
│ │负责人      ││                                              │
│ └────────────┘│                                              │
└───────────────┴──────────────────────────────────────────────┘
```

交互要点：
- 表头固定，支持多列排序。
- 鼠标悬停行显示操作按钮：查看详情 / 添加跟进 / 发消息 / 收藏。
- 右侧抽屉默认收起，点击“优先处理”按钮展开；抽屉内卡片显示 KPI 与提醒。

### 13.2 详情抽屉（覆盖 70% 宽度）
```
┌─────────────────────────────────────────────────────┐
│ 顶部：名称 + 标签 + 状态徽章 + 收藏按钮 + 操作菜单     │
├─────────────────────────────────────────────────────┤
│ 左侧滚动区（主信息）                                 │
│ 1. 基础信息卡（logo、类型、地区、官网、评分、等级）    │
│ 2. 联系方式（主联系人 + 备用联系人列表）              │
│ 3. 合作范围（项目卡片 + 里程碑）                      │
│ 4. 合同与文件（可下载 + 到期提醒）                    │
│ 5. 关联资源（教授/学校/学生案例列表）                 │
│ 6. 风险提示与内部备注                                │
│                                                     │
│ 右侧固定栏（320px）                                  │
│ - 跟进时间线（按时间倒序，支持展开附件）             │
│ - 添加记录按钮（悬浮）                               │
│ - 任务与提醒（下次行动、责任人、提醒时间）           │
└─────────────────────────────────────────────────────┘
```

### 13.3 新建/编辑弹窗（960px 宽）
1. **步骤条** 在顶部显示 3 步：基本信息 → 联系方式 → 合作信息。
2. 每步表单左侧为输入区域，右侧为预览卡，实时展示已填数据。
3. 底部按钮：上一步 / 下一步 / 保存，保存后弹出成功提示和“继续创建”按钮。

### 13.4 移动/窄屏卡片视图（<1280px）
- 切换到卡片模式，单列堆叠，顶部显示核心字段和操作按钮。
- 详情改为全屏页面，时间线改为页签形式。

## 14. Swagger 接口规范
- 详见 `docs/api/partner-management-swagger.yaml`，覆盖列表、详情、增删改、联系人、时间线、收藏等全部接口。
- Swagger 采用 OpenAPI 3.1，已经内置 `Partner`、`PartnerContact`、`PartnerTimelineEntry` 等数据结构，方便后端快速生成校验逻辑。
- 建议在 Supabase Edge Functions 与 BFF 层引用同一份 schema，避免字段漂移。

---
> 如果需要我继续产出原型图、接口 Swagger、或将页面直接实现，请告诉我，我可以一步步带着你完成。

