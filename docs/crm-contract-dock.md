# CRM Center · 合同与签约（Contract Dock）设计文档

## 1. 模块定位
- **所属导航**：`CRM Center / Contract Dock`
- **核心使命**：标准化合同创建、审批、签署与收款流程，降低风控风险，提高签约效率。
- **使用角色**：销售顾问、销售经理、法务、财务、客户服务、管理层。

## 2. 信息架构
```
Contract Dock
├─ 合同概览
│  ├ 关键指标（签约金额、签约率、平均周期、逾期收款）
│  ├ 状态分布（草稿/审批中/签署中/已签署/变更/退款）
├─ 合同列表（可视化表格 + 看板）
│  ├ 自定义列：客户、产品、金额、阶段、负责人、审批进度
│  └ 筛选、排序、保存视图
├─ 合同详情页
│  ├ 基本信息（客户、产品、条款、付款计划、附件）
│  ├ 审批流进度条
│  ├ 签署状态与日志
│  ├ 收款/发票模块
│  └ 变更记录
├─ 模板与配置中心
│  ├ 模板库（按国家、产品、语言）
│  ├ 条款组件库 & 审批规则
│  └ 印章/签署人配置
├─ 模板市场（Template Marketplace）
│  ├ 免费模板 / 付费模板展示
│  ├ 预览 / 下载 / 立即使用
│  └ 价格与适用场景说明
└─ 报表与风控
   ├ 折扣/例外审批监控
   ├ 收款风险预测
   └ 退款/投诉处理
```

## 3. 核心流程

### 3.1 合同创建
1. 销售在客户详情页点击“创建合同”，选择模板（按产品线/国家过滤）。
2. 填写动态字段（服务周期、拟定金额、付款计划、特别条款）。
3. 系统自动校验必填项、金额范围、审批规则；若触发例外（如超折扣），标记需高级审批。
4. 可上传补充附件（报价单、沟通纪要），并添加内部备注。

### 3.2 审批与签署
1. 合同提交后进入审批流程：可配置串行/并行节点（销售经理→法务→财务→管理层）。
2. 审批人收到通知（邮件、站内、手机），可查看合同详情、历史版本、修改建议。
3. 审批通过后进入签署阶段：支持电子签平台，设置客户/公司签署顺序、签名位置。
4. 签署完成后系统自动归档合同 PDF，更新状态，并通知相关人员。

### 3.3 收款与发票
1. 合同创建时定义付款里程碑（定金、尾款、分期、返费）。
2. 每个里程碑可关联发票：创建申请 → 财务审核 → 开具 → 寄送 → 确认收票。
3. 收款记录与财务系统同步，逾期自动提醒销售/财务并可触发催款任务。
4. 实时展示收款进度条与金额差异，若提前/延期收款可记录原因。

### 3.4 变更与退款
1. 发起变更：调整条款、延期、补充协议；系统自动生成变更记录并进入审批。
2. 退款流程：填写退款原因、金额、客户银行信息，审批后触发财务处理并更新合同状态。
3. 所有变更写入审计日志，保证追溯性与合规。

## 4. 数据模型
- `Contract`：合同主档（id、code、customer_id、product_id、amount、currency、status、owner_id、template_id、created_at、updated_at）。
- `ContractVersion`：版本记录（contract_id、version_no、changes、created_by、created_at）。
- `ApprovalFlow`：审批定义（flow_id、name、steps[]、rules）。
- `ApprovalTask`：审批节点（contract_id、step_id、approver_id、status、comment、timestamp）。
- `Signature`：签署信息（contract_id、party_type、signer_name、signer_email、sign_order、status、signed_at、signature_file）。
- `PaymentPlan`：付款计划（contract_id、milestone_name、due_date、amount、status、invoice_id）。
- `Invoice`：发票记录（id、contract_id、amount、type、status、issue_date、delivery_info）。
- `Refund`：退款单（id、contract_id、amount、reason、status、processed_at、attachment）。

## 5. API 草案
| 功能 | Method | Endpoint | 说明 |
|------|--------|----------|------|
| 创建合同 | POST | `/api/crm/contracts` | 选择模板、填充字段、保存草稿或提交审批 |
| 查询合同 | GET | `/api/crm/contracts` | 支持多条件过滤、分页、导出 |
| 更新合同 | PATCH | `/api/crm/contracts/:id` | 修改草稿、发起变更 |
| 提交审批 | POST | `/api/crm/contracts/:id/submit` | 进入审批流 |
| 审批动作 | POST | `/api/crm/contracts/:id/approve` | 审批通过/驳回、填写意见 |
| 发起签署 | POST | `/api/crm/contracts/:id/sign` | 生成签署链接、配置签署人 |
| 同步签署状态 | POST | `/api/crm/contracts/:id/signature-callback` | 接收电子签回调 |
| 管理付款计划 | POST/PATCH | `/api/crm/contracts/:id/payment-plan` | 增删付款节点、更新状态 |
| 发票处理 | POST | `/api/crm/invoices` | 创建发票；支持状态更新接口 |
| 退款申请 | POST | `/api/crm/contracts/:id/refund` | 提交退款，进入审批 |

## 6. UI/UX 细节
- **页面分区**：顶部提供“概览仪表盘 / 合同执行 / 模板与配置 / 法律与风控”四大子功能入口，支持卡片式切换，保持信息聚焦不过载。
- **合同列表**：表格+看板双视图；表格支持多列筛选、条件保存、列自定义，并额外展示阶段徽标、风险标签与付款进展摘要；看板按阶段（草稿/审批/签署/完成）展示卡片。
- **合同详情**：分为“概览”“条款”“审批”“收款”“变更”五个 Tab。
  - 概览展示关键数据、进度条、提醒。
  - 条款区域支持展开镜像原文与结构化表单。
  - 审批 Tab 显示流程图与历史审批记录。
  - 收款 Tab 以时间线展示每个节点、发票状态。
- **模板中心 & 模板市场**：管理员维护官方模板，可预览、版本对比；模板市场提供免费/付费模板，一键预览、下载或使用。
- **模板库弹窗**：顶栏快捷按钮可唤出分区化模板库弹窗（含分类筛选、搜索、AI 推荐），体验对齐知识库模板中心。
- **法律咨询弹窗**：快捷入口支持预约流程、风险指南与合规快讯的集中查看，统一联系律所顾问。
- **提醒**：右上角提示即将到期审批、待签署合同、逾期收款等；模板市场提供付费模板授权提醒。

## 7. 自动化与规则
- 合同金额超过阈值自动增加管理层审批节点。
- 折扣率超标自动触发法务确认，附带必须填写的说明字段。
- 签署成功后触发：1）更新 CRM 状态；2）创建项目/服务记录；3）通知相关团队。
- 收款逾期超过 X 天，自动创建催款任务并抄送经理。
- 退款审批完成后自动生成退款通知单并推送客服。
- 模板市场：按产品、国家筛选模板，支持价格展示、预览、下载、购买后直接套用。
- 法律指导：内置风险提示助手、标准条款指南，可预约合作律所进行疑难咨询。

## 8. 指标与监控
- 签约率、平均签约周期、审批耗时、签署耗时。
- 折扣占比、例外审批数量、合同变更次数。
- 收款达成率、逾期金额、发票及时率。
- 退款金额、退款原因分布、客户满意度反馈。
- 审批节点效率：每个审批人平均处理时长、待办积压量。

## 9. 权限与合规
- 销售：创建/查看自身合同，触发审批，查看审批意见。
- 销售经理：查看团队合同，可批量导出、审批。
- 法务/财务：只负责所需审批、查看条款、发票、收款信息。
- 管理层：全局查看、审核例外、调整配置。
- 合规要求：所有操作写入审计日志；合同版本、审批、签署、变更、退款均需可追溯。
- 法律顾问模块：提供 AI 风险提示、条款指南、律师预约记录。

## 10. 迭代路线
1. **MVP**：模板套用、基本审批、电子签对接、收款计划、发票记录。
2. **阶段二**：动态审批规则、折扣/例外监控、催款自动化、退款流程。
3. **阶段三**：合同变更管理、BI 报表、风险评分、外部 ERP/财务系统对接。
4. **阶段四**：智能推荐条款、自动生成合同（基于报价单）、风险预测模型。

---
后续可扩展“合同审批仪表盘”“供应商/第三方合同管理”等高级功能，以实现企业级合同全生命周期管理。
